<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Infoxicator | Ruben Casas</title><meta name="description" content="Personal blog and portfolio of Ruben Casas - Software Engineer, Micro Frontend enthusiast, and lifelong learner."/><meta name="keywords"/><meta name="twitter:title" content="Infoxicator | Ruben Casas"/><meta name="twitter:description" content="Personal blog and portfolio of Ruben Casas - Software Engineer, Micro Frontend enthusiast, and lifelong learner."/><meta name="twitter:creator" content="@tannerlinsley"/><meta name="twitter:site" content="@tannerlinsley"/><meta name="og:type" content="website"/><meta name="og:title" content="Infoxicator | Ruben Casas"/><meta name="og:description" content="Personal blog and portfolio of Ruben Casas - Software Engineer, Micro Frontend enthusiast, and lifelong learner."/><link rel="modulepreload" href="/assets/main-B2jn8-El.js"/><link rel="modulepreload" href="/assets/_postId-DKMZReAd.js"/><link rel="modulepreload" href="/assets/posts-BDliQh2j.js"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest" color="#fffff"/><link rel="icon" href="/favicon.ico"/><link rel="stylesheet" href="/assets/app-CSTvrx6g.css"/><script>
          (function() {
            const theme = localStorage.getItem('theme');
            if (theme) {
              document.documentElement.setAttribute('data-theme', theme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
              document.documentElement.setAttribute('data-theme', 'dark');
            }
          })();
        </script></head><body class="min-h-screen flex flex-col"><div class="w-full overflow-hidden transition-all duration-300 ease-in-out" style="max-height:0px"><div class="w-full border-b border-theme bg-secondary"><div class="max-w-3xl mx-auto px-6 py-3 flex items-center justify-end gap-3"><button class="flex flex-col items-center gap-1 group" aria-label="Light"><div class="relative w-10 h-10 rounded-full transition-transform group-hover:scale-110 ring-2 ring-offset-2 ring-[var(--accent)]" style="background-color:#ffffff;border-width:2px;border-style:solid;border-color:#0066cc"><svg class="w-6 h-6 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" fill="none" stroke="#0066cc" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"></path></svg></div><span class="text-xs transition-colors text-accent">Light</span></button><button class="flex flex-col items-center gap-1 group" aria-label="Dark Side"><div class="relative w-10 h-10 rounded-full transition-transform group-hover:scale-110 " style="background-color:#040405;border-width:2px;border-style:solid;border-color:#FF2A2A"><svg class="w-6 h-6 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" fill="none" stroke="#FF2A2A" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"></path></svg></div><span class="text-xs transition-colors text-muted group-hover:text-primary">Dark Side</span></button><button class="flex flex-col items-center gap-1 group" aria-label="Terminal"><div class="relative w-10 h-10 rounded-full transition-transform group-hover:scale-110 " style="background-color:#020806;border-width:2px;border-style:solid;border-color:#00FF9C"><svg class="w-6 h-6 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" fill="none" stroke="#00FF9C" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"></path></svg></div><span class="text-xs transition-colors text-muted group-hover:text-primary">Terminal</span></button><button class="flex flex-col items-center gap-1 group" aria-label="Vibe Code"><div class="relative w-10 h-10 rounded-full transition-transform group-hover:scale-110 " style="background-color:#0C0616;border-width:2px;border-style:solid;border-color:#6E1AE9"><svg class="w-6 h-6 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" fill="none" stroke="#6E1AE9" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"></path></svg></div><span class="text-xs transition-colors text-muted group-hover:text-primary">Vibe Code</span></button></div></div></div><header class="w-full border-b border-theme"><div class="max-w-3xl mx-auto px-6 py-4 flex items-center justify-between"><a href="/" class="text-lg font-semibold text-primary hover:text-accent transition-colors">~/infoxicator</a><nav class="flex items-center gap-6"><a href="/" class="text-sm text-muted hover:text-primary transition-colors">home</a><a href="/blog" class="text-sm text-muted hover:text-primary transition-colors">blog</a><button class="flex items-center justify-center w-9 h-9 bg-secondary rounded hover:bg-tertiary transition-colors" aria-label="Select theme"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42"></path></svg></button></nav></div></header><main class="flex-1 w-full max-w-3xl mx-auto px-6 py-8"><!--$--><div class="fixed top-0 left-0 right-0 z-50 h-1" style="background-color:var(--border)"><div class="h-full transition-[width] duration-75 ease-out" style="width:0%;background-color:var(--accent)"></div></div><article class="space-y-8"><a href="/" class="inline-flex items-center gap-2 text-sm text-muted hover:text-accent transition-colors"><span aria-hidden="true">←</span>Back to home</a><header class="space-y-4"><div class="flex items-center gap-3 text-sm text-muted"><time dateTime="2022-10-06">October 6, 2022</time><span>·</span><span>7 min read</span></div><h1 class="text-3xl font-bold text-primary">React Router 6.4 Code-Splitting</h1><div class="flex flex-wrap gap-2"><span class="text-xs px-2 py-1 bg-tertiary rounded text-muted">React</span><span class="text-xs px-2 py-1 bg-tertiary rounded text-muted">React Router</span><span class="text-xs px-2 py-1 bg-tertiary rounded text-muted">Performance</span><span class="text-xs px-2 py-1 bg-tertiary rounded text-muted">Code Splitting</span></div></header><div class="prose"><div><div><figure>
  <img src="/images/posts/react-router-6-4-code-splitting/xy2km3wsql2sq9jzdkgm.jpeg" alt="React Router 6.4 Code-Splitting cover" />
</figure>

<p>The Remix team have released the new &#8220;Data Routers&#8221; in their <code>6.4</code> update that brings all of the great features of Remix over to React Router. With this update, Single Page Applications that are unable to migrate can benefit from all of the goodies &#x1f381; that Remix provides.</p>



<p>The best feature by far is parallel data fetching, removing the &#8220;Spinnageddon&#8221; network waterfall and improving page loads.</p>



<figure class="wp-block-image"><img src="/images/posts/react-router-6-4-code-splitting/xy2km3wsql2sq9jzdkgm.jpeg" alt="Parallel bars in network waterfall"/></figure>



<p>These parallel green bars look awesome! and your users will be delighted too:</p>



<ul><li>No Content Layout Shift</li><li>Faster data loading.</li><li>A single loading spinner (unavoidable without Remix because of Client Side Rendering, but that&#8217;s better than multiple ones).</li></ul>



<p>It all sounds great, so what&#8217;s missing?</p>



<p>The new Data Router and routes that need data upfront have to define their loaders and components at the top level of the application and that puts the entire app into a single massive bundle &#x1f914;</p>



<p>Hundreds of MBs of JavaScript when you land on the page is a no-no for performance so… how do we codesplit a Data Router application while keeping the benefits of parallel data fetching and no Content Layout Shift?</p>



<h2>Option 1</h2>



<h3>Route Modules with Loaders and Components in the same file:</h3>



<p>This option follows the Remix file conventions where every route exports both the <code>Component</code> and the <code>Loader</code> from the same file, then it uses a <code>Route Module</code> file to lazy load and dynamic import these files to enable code-splitting.</p>



<pre class="wp-block-code"><code lang="javascript" class="language-javascript">export async function loader(args) {
  let actualLoader = await import("./actualModule").loader;
  return actualLoader(args);
}

export const Component = React.lazy(() =&gt; import("./actualModule").default);</code></pre>



<pre class="wp-block-code"><code lang="javascript" class="language-javascript">import * as Tasks from "./tasks.route";

// ...
&lt;Route
  path="/tasks"
  element={
     &lt;React.Suspense fallback="loading..."&gt;
       &lt;Tasks.Component /&gt;
     &lt;/React.Suspense&gt;
  }
  loader={Tasks.loader}
/&gt;;</code></pre>



<p>This resulting network waterfall:</p>



<p><br><img src="/images/posts/react-router-6-4-code-splitting/yoro7oq746jygrf775dn.png" alt="Network waterfall with two bars"></p>



<p><strong>Pros:</strong></p>



<ul><li>This is a really clean pattern and can be encapsulated to build your own route configuration.</li><li>Closer to Remix file conventions so it would be easier to migrate in the future.</li></ul>



<p><strong>Cons:</strong></p>



<ul><li>The data loading and <code>fetch</code> are delayed until the Component bundle is loaded.</li><li>Content Layout Shift occurs because of the suspense boundary.</li></ul>



<h2>Option 2</h2>



<h3>&nbsp;Moving loaders into their own separate file</h3>



<p>Separating the loader out of the Component file allows you to code split the Component and fetch it from the loader while the data is loading, eliminating the sequential download and making the most of parallelisation.</p>



<figure class="wp-block-image"><img src="/images/posts/react-router-6-4-code-splitting/f8qdoz0jqn9zbj81nohp.png" alt="Network waterfall with two bars"/></figure>



<p>Move <code>actual-loader</code> to a separate file.</p>



<pre class="wp-block-code"><code class="">export async function loader() {
  // import the Component here but don't await it
  import("./actualModule");
  return await fetch('/api');
}</code></pre>



<p>When React.lazy actually mounts and calls its own<br><code>import('./actualModule')</code>, it should latch onto the existing download.</p>



<blockquote class="wp-block-quote"><p></p><p>Disclaimer: Most modern bundlers should support the theory above, but it is not guaranteed.</p></blockquote>



<p><strong>Pros:</strong></p>



<ul><li>The Component and Loader can be code-split into separate files.</li><li>The Component&#8217;s javascript bundle and the data fetching start at the same time, this is particularly useful for heavy components that might take a while to load from the network.</li></ul>



<p><strong>Cons:</strong></p>



<ul><li>This approach moves away from Remix file conventions so a small refactoring to move the loaders could be needed if migrating to Remix</li><li>Content Layout Shift still occurs even though the component lazy import promise could have potentially resolved when the loader is finished, the suspense boundary still needs to unwrap the resolved value.</li></ul>



<h2>Removing Content Layout Shift</h2>



<p>Both options have their benefits, however, both suffer from Content Layout Shift. Removing CLS is one of the main performance benefits of React Router and Remix but now that we have introduced code-splitting it makes CLS unavoidable… or does it?</p>



<p><a href="https://twitter.com/brophdawg11">Matt</a> from the Remix team put together a really cool trick on how to remove CLS when code-splitting and the best part is that it works for both of the solutions mentioned above.</p>



<pre class="wp-block-code"><code lang="javascript" class="language-javascript">// Assume you want to do this in your routes, which are in the critical path JS bundle
&lt;Route path="lazy" loader={lazyLoader} element={&lt;Lazy /&gt;} /&gt;

// And assume you have two files containing your actual load and component:
// lazy-loader.ts -&gt; exports the loader
// lazy-component.ts -&gt; exports the component

// We'll render the component via React.lazy()
let LazyActual = React.lazy(() =&gt; import("./lazy-component"));

function Lazy() {
  return (
    &lt;React.Suspense fallback={&lt;p&gt;Loading component...&lt;/p&gt;}&gt;
      &lt;LazyActual /&gt;
    &lt;/React.Suspense&gt;
  );
}

// The loader is where things get interesting, we need to load the JS chunk 
// containing our actual loader code - BUT we also want to get a head start 
// on downloading the component chunk instead of waiting for React.lazy() to 
// kick it off.  Waterfalls are bad!  This opens up the possibility of the 
// component chunk finishing _before_ the loader chunk + execution.  If that 
// happens we don't want to see a small CLS flicker from Suspense since the 
// component _is already downloaded_!
export async function lazyLoader(...args) {
  let controller = new AbortController();

  /*
   * Kick off our component chunk load but don't await it
   * This allows us to parallelise the component download with loader 
   * download and execution.
   *
   * Normal React.lazy()
   * 
   *   load loader.ts     execute loader()   load component.ts
   *   -----------------&gt; -----------------&gt; -----------------&gt;
   *
   * Kicking off the component load _in_ your loader()
   * 
   *   load loader.ts     execute loader()   
   *   -----------------&gt; -----------------&gt; 
   *                      load component.ts
   *                      -----------------&gt;
   *
   * Kicking off the component load _alongside_ your loader.ts chunk load
   * 
   *   load loader.ts     execute loader()   
   *   -----------------&gt; -----------------&gt; 
   *   load component.ts
   *   -----------------&gt;
   */
  import("./lazy-component").then(
    (componentModule) =&gt; {
      if (!controller.signal.aborted) {
        // We loaded the component _before_ our loader finished, so we can
        // blow away React.lazy and just use the component directly.  This 
        // avoids the flicker we'd otherwise get since React.lazy would need 
        // to throw the already-resolved promise up to the Suspense boundary 
        // one time to get the resolved value
        LazyActual = componentModule.default;
      }
    },
    () =&gt; {}
  );

  try {
    // Load our loader chunk
    let { default: loader } = await import("./lazy-loader");
    // Call the loader
    return await loader(...args);
  } finally {
    // Abort the controller when our loader finishes.  If we finish before the 
    // component chunk loads, this will ensure we still use React.lazy to 
    // render the component since it's not yet available.  If the component 
    // chunk finishes first, it will have overwritten Lazy with the legit 
    // component so we'll never see the suspense fallback
    controller.abort();
  }
}</code></pre>



<p><a href="https://gist.github.com/brophdawg11/03a475e26922e09aa35ca8b5900a4fb4">Source Code</a></p>



<p>Thanks again to <a href="https://twitter.com/brophdawg11">Matt</a> from Remix for helping me to figure this one out! all the credit goes to him.</p></div></div></div><footer class="pt-8 border-t border-theme"><a href="/" class="inline-flex items-center gap-2 text-sm text-muted hover:text-accent transition-colors"><span aria-hidden="true">←</span>Back to all posts</a></footer></article><script></script><script>(function restoreScroll({
  storageKey: storageKey2,
  key,
  behavior,
  shouldScrollRestoration,
  scrollToTopSelectors,
  location
}) {
  let byKey;
  try {
    byKey = JSON.parse(sessionStorage.getItem(storageKey2) || "{}");
  } catch (error) {
    console.error(error);
    return;
  }
  const resolvedKey = key || window.history.state?.__TSR_key;
  const elementEntries = byKey[resolvedKey];
  ignoreScroll = true;
  scroll: {
    if (shouldScrollRestoration && elementEntries && Object.keys(elementEntries).length > 0) {
      for (const elementSelector in elementEntries) {
        const entry = elementEntries[elementSelector];
        if (elementSelector === "window") {
          window.scrollTo({
            top: entry.scrollY,
            left: entry.scrollX,
            behavior
          });
        } else if (elementSelector) {
          const element = document.querySelector(elementSelector);
          if (element) {
            element.scrollLeft = entry.scrollX;
            element.scrollTop = entry.scrollY;
          }
        }
      }
      break scroll;
    }
    const hash = (location ?? window.location).hash.split("#", 2)[1];
    if (hash) {
      const hashScrollIntoViewOptions = window.history.state?.__hashScrollIntoViewOptions ?? true;
      if (hashScrollIntoViewOptions) {
        const el = document.getElementById(hash);
        if (el) {
          el.scrollIntoView(hashScrollIntoViewOptions);
        }
      }
      break scroll;
    }
    const scrollOptions = { top: 0, left: 0, behavior };
    window.scrollTo(scrollOptions);
    if (scrollToTopSelectors) {
      for (const selector of scrollToTopSelectors) {
        if (selector === "window") continue;
        const element = typeof selector === "function" ? selector() : document.querySelector(selector);
        if (element) element.scrollTo(scrollOptions);
      }
    }
  }
  ignoreScroll = false;
})({"storageKey":"tsr-scroll-restoration-v1_3","shouldScrollRestoration":true});document.currentScript.remove()</script><!--/$--></main><footer class="w-full border-t border-theme"><div class="max-w-3xl mx-auto px-6 py-6 flex flex-col sm:flex-row items-center justify-between gap-4 text-sm text-muted"><span>© <!-- -->2025<!-- --> Ruben Casas</span><div class="flex items-center gap-4"><a href="https://twitter.com/infoxicator" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">twitter</a><a href="https://github.com/infoxicator" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">github</a><a href="https://linkedin.com/in/ACoAABJb0mgBc6L_x1w-l_cGNMY4VpnDPZ2vEQQ" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">linkedin</a></div></div></footer><script class="$tsr" id="$tsr-stream-barrier">(self.$R=self.$R||{})["tsr"]=[];self.$_TSR={h(){this.hydrated=!0,this.c()},e(){this.streamEnded=!0,this.c()},c(){this.hydrated&&this.streamEnded&&(delete self.$_TSR,delete self.$R.tsr)},p(e){this.initialized?e():this.buffer.push(e)},buffer:[]};
;$_TSR.router=($R=>$R[0]={manifest:$R[1]={routes:$R[2]={__root__:$R[3]={preloads:$R[4]=["/assets/main-B2jn8-El.js"],assets:$R[5]=[$R[6]={tag:"script",attrs:$R[7]={type:"module",async:!0},children:"import('/assets/main-B2jn8-El.js')"}]},"/$postId":$R[8]={preloads:$R[9]=["/assets/_postId-DKMZReAd.js","/assets/posts-BDliQh2j.js"]}}},matches:$R[10]=[$R[11]={i:"__root__/",u:1767031041321,s:"success",ssr:!0},$R[12]={i:"/$postId/react-router-6-4-code-splitting",u:1767031041372,s:"success",ssr:!0}],lastMatchId:"/$postId/react-router-6-4-code-splitting"})($R["tsr"]);$_TSR.e();document.currentScript.remove()</script><script type="module" async="">import('/assets/main-B2jn8-El.js')</script></body></html>